---
title: "Social Media Companies"
description: | 
  Wie haben sich ihre Aktienkurse in der Pandemie verändert?
output:
  distill::distill_article:
    toc: true
    toc_depth: 2
    toc_float: false
params:
  stocks: ["FB", "TWTR", "SNAP", "PINS"]
  fiscal_year: 2020
---


```{r setup, include = FALSE}
library(knitr)
library(kableExtra)
library(gt)
library(gtExtras)
options(scipen = 1, digits = 3)
opts_chunk$set(comment=NA, warning = FALSE, message = FALSE)
plotutils::set_custom_theme(base_size = 18)
```



```{r libraries, include=FALSE}
# required libraries
library(tidyverse)
library(simfinapi)
library(httr)
library(jsonlite)
library(lubridate)
```



```{r webapi, eval=FALSE, include = FALSE}
# Einfaches Beispiel der Verwendung einer API
my_apikey <- readLines(here::here("scripts", "api_key.txt"))

base_url <- "https://simfin.com/api/v2/"

endpoint <- "companies/list"

url <- paste0(base_url, endpoint, "?api-key=", my_apikey)

get_companies <- GET(url)

# Check if it worked
get_companies$status_code

content_raw <- content(get_companies, type = "text")

content_json <- fromJSON(content_raw, flatten = TRUE) 
  
content_df <- tibble(simfin_id = unlist(content_json$data[, 1]),
                     ticker = unlist(content_json$data[, 2]))


# Define ticker. Wir wollen uns z.B. den Aktienkurs von Apple anschauen.
ticker <- "AAPL"

# the statement to retrieve. 
statement <- "pl"

# the period & financial year to retrieve
period <- "q2"
fyear <- 2021

# create url
url <- paste0(base_url, "companies/statements?api-key=", my_apikey, "&ticker=", ticker, 
              "&statement=", statement, "&period=", period,"&fyear=", fyear)

# make request
get_data <- GET(url)

# convert JSON
data_json <- fromJSON(content(get_data, "text"), flatten = TRUE) 

apple_df <- tibble(variable = unlist(data_json$columns),
                   value = unlist(data_json$data))


# All das können wir uns erleichtern, weil jmd anderes ein Paket gebaut hat

```


# Fragestellung

Wie haben sich die Aktienkurse verschiedener sozialer Netzwerke im Jahr 
`r params$fiscal_year` entwickelt? Wurden alle Unternehmen gleichermaßen von 
Corona getroffen? Konnten Digitalunternehmen profitieren?

Für eine nähere Betrachtung und für eine Bewertung schauen wir auf eine 
interessante Zielmetrik für Digitalunternehmen. Diese lautet die Rule of 40. 

# Zusammenfassung

Generell hat sich der Aktienkurs der untersuchten Unternehmen nach einem
kurzen globalen Einbruch der Weltwirtschaft Mitte März recht schnell wieder
erholt. Insbesondere Pinterest konnte im Vergleich stärker anwachsen als die 
anderen betrachteten Unternehmen. Eine Hypothese ist, dass gerade Pinterest
von dem Rückzug in die eigenen vier Wände profitieren konnte. Auf dieser 
Plattform sind die Themen Gestaltung und Verschönern des Zuhauses, des Gartens
etc. beliebt.

Blablabla...


# Analyse

Hier werfen wir einen näheren Blick auf die Aktienkurse der Unternehmen.

## Aktienkurse im Jahresverlauf

```{r simfinapi, echo=FALSE, fig.height=4, fig.width=6, layout="l-body-outset"}
# Setting the api key
sfa_set_api_key(api_key = readLines(here::here("scripts", "api_key.txt")))
sfa_set_cache_dir(here::here("scripts", "simfin_cache"), create = TRUE)

company_infos <- sfa_get_info(ticker = params$stocks)

shares <- sfa_get_prices(ticker = params$stocks) %>% 
  left_join(company_infos)

shares %>% 
  mutate(year = year(date)) %>% 
  filter(year == params$fiscal_year) %>%
  ggplot(aes(x = date, y = adj_close)) +
  geom_line() +
  facet_wrap(~company_name, scales = "free_y") +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  labs(x = NULL,
       y = "Kurs in $") 

shares %>% 
  mutate(year = year(date)) %>% 
  filter(year == params$fiscal_year) %>%
  ggplot(aes(x = date, y = log(adj_close), colour = company_name)) +
  geom_line(lwd = 1.2) +
  viridis::scale_colour_viridis(discrete = TRUE) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b") +
  labs(
       subtitle = "Vergleich mit logarithmierter Y-Achse",
       x = NULL,
       y = "log($)",
       colour = NULL) 

```


Nun blicken wir auf den durchschnittlichen logarithmierten Return und seine
Standardabweichung.

```{r log returns, echo = FALSE}
mean_log_returns <- shares %>% 
  mutate(year = year(date)) %>% 
  filter(year == params$fiscal_year) %>% 
  group_by(company_name) %>% 
  summarize(mean_log_return = mean(log(adj_close)),
            sd_log_return = sd(log(adj_close)))

mean_log_returns %>% 
  gt() %>% 
  tab_header(title = "Mean Log Returns")
```


## Rule of 40

Die Rule of 40^[https://kpisense.com/glossary/rule-of-40] wird klassischerweise 
bei Software Firmen angewendet, um 
deren Entwicklung zu bewerten. Dabei sollen zwei Metriken
einfließen. Einerseits das Wachstum des Unternehmens und andererseits der
Profit. In den ersten Jahren eines Unternehmens ist es üblich, dass 
es noch keinen Profit gibt, aber Wert auf Wachstum gelegt wird. 

$$
Rule of 40 = Growth + Profit Margin
$$

Diese Metrik kann selbstverständlich auch gewichtet werden, falls eine der 
beiden Komponenten als relevanter erachtet wird. 

Nun schauen wir uns an wie diese Metrik für die Unternehmen am Ende des
Geschäftsjahres `r params$fiscal_year` (4. Quartal) aussieht. 


```{r rule_40, echo=FALSE}

balance_sheet <- sfa_get_statement(ticker = params$stocks,
                                   fyear = params$fiscal_year,
                                   statement = "bs")

derived_q4 <- sfa_get_statement(ticker = params$stocks,
                                fyear = params$fiscal_year,
                                period = "q4",
                                statement = "derived")

derived_q3 <- sfa_get_statement(ticker = params$stocks,
                                fyear = params$fiscal_year,
                                period = "q3",
                                statement = "derived")

profit_loss_q4 <- sfa_get_statement(ticker = params$stocks,
                                    fyear = params$fiscal_year,
                                    period = "q4",
                                    statement = "pl")

profit_loss_q3 <- sfa_get_statement(ticker = params$stocks,
                                    fyear = params$fiscal_year,
                                    period = "q3",
                                    statement = "pl")
# Define our own Metric
rule_40 <- profit_loss_q4 %>% 
  select(ticker, fiscal_year, revenue) %>%
  mutate(growth = revenue/profit_loss_q3$revenue - 1) %>% 
  inner_join(select(derived_q4, net_profit_margin, ticker)) %>% 
  mutate(rule_40 = growth + net_profit_margin,
         revenue = revenue/1000000)

rule_40 %>% 
  gt() %>% 
  tab_header(title = "Rule of 40") %>% 
  gt_color_rows(rule_40, palette = c("#AEEAE3", "#2BA193"), use_paletteer = FALSE)
```

Wir sehen, dass das Unternehmen `r rule_40$ticker[which.max(rule_40$rule_40)]`
den höchsten Wert aufweist. 





