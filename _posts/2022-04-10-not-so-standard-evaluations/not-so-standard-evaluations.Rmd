---
title: "Not so standard evaluations"
description: |
  Getting a better understanding of the tidyeval framework
author:
  - name: Lukas GrÃ¶ninger
preview: img/glass.jpg
date: 2022-04-10
categories:
  - R
output:
  distill::distill_article:
    toc: true
    toc_depth: 3
    self_contained: false
draft: true
---



```{r setup, include=FALSE}
library(knitr)
library(kableExtra)
library(rmarkdown)
options(scipen = 100000, digits = 3)
opts_chunk$set(comment=NA, warning = FALSE, message = FALSE)

```


The R language has some peculiarities. One of these is the use of 
non standard evaluation (NSE) and the notion of Metaprogramming.
I'm using R for quite some time now and these concepts have already given me 
some serious headaches (and probably continue to do so...). 
In the first two years of using R (it was my first programming language), 
I have not given a single thought to this idea, because I didn't need it at all.
Furthermore, I didn't even question why the following was working:

```{r}
mtcars |> dplyr::filter(cyl == 6)
```

How does R know where to find `cyl` and why does both `library(dplyr)` and 
`library("dplyr")` work?

I don't recall which problem I tried to fix, but one day I landed on a stackoverflow thread 
where one solution used the `!!` (bang-bang) operator. I have never seen it before and was puzzled. 
I copied the code and was glad that it worked, but I had no idea why. 
The more I started to define my own functions, the more I stumbled across this
strange topic of non standard evaluations and Metaprogramming. There were more than a
handful of expressions (`r emo::ji("wink")`) I couldn't grasp. Examples are:


- Quasiquotation
- !! (Bang-Bang Operator) 
- ... (Dynamic dots)
- Data Masking
- !!! (Big Bang or unquote-splice Operator) 
- Defusing an expression
- `{{}}` (Embrace, Curly-Curly or Doublestash Operator)
- Closures
- Quosures

All of these concepts seem highly complex and difficult and this post is not 
about trying to explain all or any of them in detail. There are great resources 
in the [{rlang}](https://rlang.r-lib.org/index.html) documentation as well as in  
the [Big Picture Chapture](https://adv-r.hadley.nz/meta-big-picture.html) of
Advanced R. What also helped me a lot was the [Tidy Evaluation](https://tidyeval.tidyverse.org/sec-up-to-speed.html)
book by Lionel Henry and Hadley Wickham. 


[quo vs enquo](https://stackoverflow.com/questions/53067407/tidyeval-quo-vs-enquo)



The you stumble across the Bang-Bang operator in a stack overflow thread

This post should serve as a resource to find other helpful articles on the topic
and to provide an example I used a couple of weeks ago.


- [Programming with Dplyr](https://dplyr.tidyverse.org/articles/programming.html) article
- [Tips on non-standard evaluation](https://renkun.me/2014/12/03/tips-on-non-standard-evaluation-in-r/) by Kun Ren
- [Standard and non standard evaluation](https://www.brodieg.com/2020/05/05/on-nse/) by Brodie Gaslam
- [Tidy Evaluation](https://tidyeval.tidyverse.org/sec-up-to-speed.html)
- [Tidy Eval is confusing sometimes](https://www.kelly-bodwin.com/blog/tidyeval/) by Kelly Bodwin
- [On quosures](https://www.brodieg.com/2020/08/11/quosures/#:~:text=rlang%3A%3Aquo%20is%20used,relation%20to%20base%3A%3Aenquote%20.)





```{r}
library(tidyverse)
library(palmerpenguins)



```



```{r}
penguins



count_summary_stache <- function(df, vars, sort = TRUE) {
  col_names <- df |>
    select({{vars}}) |>
    names()
  
  col_names |>
    map(~count(df, !!sym(.x), sort = sort)) |>
    set_names(col_names)
}

count_summary_dots <- function(df, ..., sort = TRUE) {
  col_names <- df |>
    select(...) |>
    names()
  
  col_names |>
    map(~count(df, !!sym(.x), sort = sort)) |>
    set_names(col_names)
}


count_summary_tidyselect <- function(df, vars, sort = TRUE) {
  expr <- rlang::enquo(vars)
  col_names <- tidyselect::eval_select(expr, data = df) |>
    names()
  col_names |>
    map(~count(df, !!sym(.x), sort = sort)) |>
    set_names(col_names)
}









```






























